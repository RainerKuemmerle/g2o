name: Wheel

on:
  #push:
  #  branches:
  #    - pymem
  #pull_request:
  #  branches:
  #    - pymem
  workflow_dispatch:
    inputs:
      upload_pypi:
        description: 'True to upload to pypi'
        required: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  make_sdist:
    name: Make SDist
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Build SDist
      run: pipx run build --sdist
    - uses: actions/upload-artifact@v4
      with:
        name: cibw-sdist
        path: dist/*.tar.gz

  # reference https://github.com/scikit-learn/scikit-learn/blob/main/.github/workflows/wheels.yml
  build_wheels:
    name: Build wheel for cp${{ matrix.python }}-${{ matrix.platform_id }}-${{ matrix.manylinux_image }}
    runs-on: ${{ matrix.os }}
    strategy:
      # Ensure that a wheel builder finishes even if another fails
      fail-fast: false
      matrix:
        include:
          ## Window 64 bit
          - os: windows-latest
            python: 310
            platform_id: win_amd64
          - os: windows-latest
            python: 311
            platform_id: win_amd64
          - os: windows-latest
            python: 312
            platform_id: win_amd64
          - os: windows-latest
            python: 313
            platform_id: win_amd64

          # Linux 64 bit manylinux_2_28
          - os: ubuntu-latest
            python: 310
            platform_id: manylinux_x86_64
            manylinux_image: manylinux_2_28
          - os: ubuntu-latest
            python: 311
            platform_id: manylinux_x86_64
            manylinux_image: manylinux_2_28
          - os: ubuntu-latest
            python: 312
            platform_id: manylinux_x86_64
            manylinux_image: manylinux_2_28
          - os: ubuntu-latest
            python: 313
            platform_id: manylinux_x86_64
            manylinux_image: manylinux_2_28

          ## Linux 64 bit manylinux_2_28
          #- os: ubuntu-24.04-arm
          #  python: 310
          #  platform_id: manylinux_aarch64
          #  manylinux_image: manylinux_2_28
          #- os: ubuntu-24.04-arm
          #  python: 311
          #  platform_id: manylinux_aarch64
          #  manylinux_image: manylinux_2_28
          #- os: ubuntu-24.04-arm
          #  python: 312
          #  platform_id: manylinux_aarch64
          #  manylinux_image: manylinux_2_28
          #- os: ubuntu-24.04-arm
          #  python: 313
          #  platform_id: manylinux_aarch64
          #  manylinux_image: manylinux_2_28

          ## MacOS x86_64
          #- os: macos-13
          #  python: 310
          #  platform_id: macosx_x86_64
          #- os: macos-13
          #  python: 311
          #  platform_id: macosx_x86_64
          #- os: macos-13
          #  python: 312
          #  platform_id: macosx_x86_64
          #- os: macos-13
          #  python: 313
          #  platform_id: macosx_x86_64

          ## MacOS arm64
          #- os: macos-14
          #  python: 310
          #  platform_id: macosx_arm64
          #- os: macos-14
          #  python: 311
          #  platform_id: macosx_arm64
          #- os: macos-14
          #  python: 312
          #  platform_id: macosx_arm64
          #- os: macos-14
          #  python: 313
          #  platform_id: macosx_arm64

    steps:
      - uses: actions/checkout@v4
        with:
         fetch-depth: 25

      - uses: astral-sh/setup-uv@v4

      # https://cibuildwheel.pypa.io/en/stable/
      # https://github.com/pypa/manylinux
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23.3
        env:
          CIBW_BUILD: cp${{ matrix.python }}-${{ matrix.platform_id }}
          CIBW_ARCHS: all
          CIBW_MANYLINUX_X86_64_IMAGE: ${{ matrix.manylinux_image }}
          CIBW_MANYLINUX_I686_IMAGE: ${{ matrix.manylinux_image }}

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  upload_all:
    needs: [build_wheels, make_sdist]
    runs-on: ubuntu-latest
    if: ${{ inputs.upload_pypi }}
    steps:
    - uses: actions/download-artifact@v4
      with:
        pattern: cibw-*
        path: dist
        merge-multiple: true
    - uses: pypa/gh-action-pypi-publish@v1.8.14
      with:
        user: __token__
        password: ${{ secrets.PYPI_TOKEN }}
