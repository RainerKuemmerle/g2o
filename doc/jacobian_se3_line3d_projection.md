# EdgeSE3Line3DProjection 解析雅可比推导

## 1. 概述

`EdgeSE3Line3DProjection` 是一条二元边，将世界系 3D 直线（Plücker 表示）投影到归一化像平面，与 2D 直线观测比较产生残差。本文档给出完整的解析雅可比推导。

**顶点**：
- `v0`: `VertexSE3` — 相机位姿，内部存储 T\_CtoW（相机到世界），扰动约定为右乘
- `v1`: `VertexLine3DTangent` — 3D 直线，Plücker 表示 L\_W = (d\_W, w\_W)，4-DOF 切空间参数化

**观测量**：`Line2D` = (θ\_obs, ρ\_obs) — 归一化平面上 2D 直线极坐标形式

**误差维度**：2

---

## 2. 符号约定

| 符号 | 含义 |
|------|------|
| T\_CtoW | 相机到世界变换 |
| T\_WtoC = T\_CtoW⁻¹ | 世界到相机变换 |
| R = R\_WtoC, t = t\_WtoC | 旋转和平移 |
| L = (d, w) | Plücker 线：d 为方向（单位向量），w 为力矩 |
| [v]× | 3×3 反对称矩阵（skew） |
| δt, δq | SE3 扰动的平移和紧凑四元数分量 |
| δω = 2·δq | 等效旋转向量（一阶近似） |

---

## 3. 观测模型

### 3.1 坐标变换

```
世界系(W) → 相机系(C)
```

Plücker 线在刚体变换下的变换公式：

```
d_C = R · d_W
w_C = [t]× · R · d_W + R · w_W
```

其中 R = R_WtoC, t = t_WtoC。

矩阵形式（Line3D 内部存储为 [w, d]，此处推导使用 [d, w] 顺序）：

```
[d_C]   [ R       0    ] [d_W]
[w_C] = [ [t]×·R  R    ] [w_W]
```

### 3.2 两点投影法

将相机系 Plücker 线投影到归一化平面 z=1，采用两点投影法：

**Step 1: 计算线上两个3D点**

```
p0_C = d_C × w_C          // 最近点（||d||=1时为线到原点的最近点）
p1_C = p0_C + d_C          // 线上另一点
```

**Step 2: 深度检查**

```
if (p0_C.z < 0.1 || p1_C.z < 0.1)
    退化——两点必须在相机前方
```

**Step 3: 透视投影到归一化平面**

```
pt0 = (p0_C.x / p0_C.z,  p0_C.y / p0_C.z)  = (u0, v0)
pt1 = (p1_C.x / p1_C.z,  p1_C.y / p1_C.z)  = (u1, v1)
```

**Step 4: 齐次叉积得到2D线**

```
l_raw = [u0, v0, 1]ᵀ × [u1, v1, 1]ᵀ
      = [ v0 - v1        ]     // n1_raw
        [ u1 - u0        ]     // n2_raw
        [ u0·v1 - u1·v0  ]     // ρ_raw
```

**归一化**（使法向量单位化）：

```
s = sqrt(n1_raw² + n2_raw²)
l_pred = l_raw / s = [n1, n2, ρ]
```

**退化检查**：
```
if (s < 1e-6)
    跳过该观测（两个投影点重合，无法确定直线）
```

### 3.3 观测表示

观测为极坐标形式 (θ\_obs, ρ\_obs)，等价于：

```
n1_obs = cos(θ_obs)
n2_obs = sin(θ_obs)
```

### 3.4 残差（2 维）

```
cross = n1_pred · n2_obs - n2_pred · n1_obs    // sin(角度差)
dot   = n1_pred · n1_obs + n2_pred · n2_obs    // cos(角度差)

res[0] = atan2(cross, dot)                     // 角度误差（弧度）

// 180° 歧义处理：当 dot < 0 时，预测与观测法线方向相反
sign = (dot >= 0) ? 1 : -1
res[1] = ρ_pred - sign · ρ_obs                 // 距离误差
```

**说明**：2D 直线 (n, ρ) 与 (-n, -ρ) 表示同一直线。当 dot < 0 时，预测法线与观测法线夹角超过 90°，此时翻转观测的符号使两者对齐。sign 取决于当前状态值，在求雅可比时视为常数。

---

## 4. 雅可比矩阵

### 4.1 状态向量

每个观测涉及的状态：

```
X = [ξ_pose,    // SE3位姿扰动 (6): [δt(3), δq(3)]
     ξ_line]    // 直线切空间 (4): [u₁, u₂, v₁, v₂]
```

### 4.2 链式法则

```
∂res/∂ξ_pose = ∂res/∂l · ∂l/∂l_raw · ∂l_raw/∂pt · ∂pt/∂p · ∂p/∂L_C · ∂L_C/∂ξ_pose
∂res/∂ξ_line = ∂res/∂l · ∂l/∂l_raw · ∂l_raw/∂pt · ∂pt/∂p · ∂p/∂L_C · ∂L_C/∂L_W · ∂L_W/∂ξ_line
```

完整展开：

```
[2×6]_pose = [2×3] · [3×3] · [3×4] · [4×6] · [6×6] · [6×6]
[2×4]_line = [2×3] · [3×3] · [3×4] · [4×6] · [6×6] · [6×6] · [6×4]
```

前五层 `∂res/∂L_C` 为共享部分 `de_dLC [2×6]`。

### 4.3 残差对归一化线 ∂res/∂l (2×3)

对 res[0] = atan2(cross, dot)，令 D = dot² + cross²：

```
∂res[0]/∂n1 = (n2_obs · dot - n1_obs · cross) / D
∂res[0]/∂n2 = (-n1_obs · dot - n2_obs · cross) / D
∂res[0]/∂ρ  = 0

∂res[1]/∂n1 = 0
∂res[1]/∂n2 = 0
∂res[1]/∂ρ  = 1
```

注意：res[1] = ρ\_pred - sign·ρ\_obs 中，sign 视为关于观测的常数，不影响对预测值 ρ\_pred 的偏导数，因此 ∂res[1]/∂ρ = 1 不变。

矩阵形式：

```
de_dl = [ (n2_obs·dot - n1_obs·cross)/D,  (-n1_obs·dot - n2_obs·cross)/D,  0 ]
        [              0,                                0,                  1 ]
```

对应代码变量 `de_dl`（第 291–297 行）。

### 4.4 归一化雅可比 ∂l/∂l\_raw (3×3)

与旧版相同。设 l\_raw = (a, b, c)，s = sqrt(a² + b²)，归一化后 n1 = a/s, n2 = b/s, ρ = c/s。

```
dl_dlraw = (1/s) · [ 1 - n1²,  -n1·n2,   0 ]
                    [ -n1·n2,   1 - n2²,  0 ]
                    [ -ρ·n1,    -ρ·n2,    1 ]
```

对应代码变量 `dl_draw`（第 302–311 行）。

### 4.5 齐次叉积雅可比 ∂l\_raw/∂pt (3×4)

l\_raw = [v0-v1, u1-u0, u0·v1-u1·v0]，对 pt = (u0, v0, u1, v1) 求导：

```
dlraw_dpt = [  0,   1,   0,  -1 ]
            [ -1,   0,   1,   0 ]
            [ v1, -u1, -v0,  u0 ]
```

对应代码变量 `dlraw_dpt`（第 318–321 行）。

### 4.6 透视投影雅可比 ∂pt/∂p (4×6)

pt0 = (p0x/p0z, p0y/p0z)，pt1 = (p1x/p1z, p1y/p1z)，对 p = (p0, p1) 求导：

```
            [ p0          | p1          ]
dpt_dp = [ 1/z0,  0, -u0/z0,  0,    0,    0   ]   ← ∂u0/∂p
         [  0, 1/z0, -v0/z0,  0,    0,    0   ]   ← ∂v0/∂p
         [  0,    0,    0,  1/z1,  0, -u1/z1  ]   ← ∂u1/∂p
         [  0,    0,    0,   0, 1/z1, -v1/z1  ]   ← ∂v1/∂p
```

对应代码变量 `dpt_dp`（第 327–336 行）。

### 4.7 3D点对 Plücker 线的雅可比 ∂p/∂L\_C (6×6)

p0 = d × w，p1 = p0 + d，对 L\_C = (d\_C, w\_C) 求导：

```
∂p0/∂d = -[w]×,       ∂p0/∂w = [d]×
∂p1/∂d = -[w]× + I,   ∂p1/∂w = [d]×
```

矩阵形式：

```
dp_dLC = [ -[w]×,      [d]×  ]   ← p0 行
         [ -[w]×+I,    [d]×  ]   ← p1 行
```

对应代码变量 `dp_dLC`（第 345–353 行）。

### 4.8 残差对相机系 Plücker 线的雅可比（共享部分）

```
de_dLC = de_dl · dl_draw · dlraw_dpt · dpt_dp · dp_dLC
       = [2×3] · [3×3] · [3×4] · [4×6] · [6×6]
       = [2×6]
```

对应代码第 356 行。

### 4.9 位姿雅可比 ∂L\_C/∂ξ\_pose (6×6)

与旧版相同：

```
dLC_dpose = [   0,        2·[d_C]×  ]    ← d_C 行
            [ [d_C]×,    2·[w_C]×  ]    ← w_C 行
```

对应代码变量 `dLC_dpose`（第 361–365 行）。

**最终位姿雅可比**：

```
J_pose = de_dLC · dLC_dpose    [2×6]
```

对应代码第 367 行 `_jacobianOplusXi`。

### 4.10 世界系变换雅可比 ∂L\_C/∂L\_W (6×6)

与旧版相同：

```
dLC_dLW = [ R,       0 ]    ← d_C 行
          [ [t]×·R,  R ]    ← w_C 行
```

对应代码变量 `dLC_dLW`（第 372–377 行）。

### 4.11 切空间参数化雅可比 ∂L\_W/∂ξ\_line (6×4)

与旧版相同：

```
             [ u₁        u₂        v₁    v₂ ]
dLW_dxi  =  [ -e₂,       e₁,       0,    0  ]    ← d 行 (3×4)
             [ e₁×w,     e₂×w,     e₁,   e₂ ]    ← w 行 (3×4)
```

对应代码变量 `dLW_dxi`（第 384–391 行）。

**最终直线雅可比**：

```
J_line = de_dLC · dLC_dLW · dLW_dxi
       = [2×6]  · [6×6]   · [6×4]
       = [2×4]
```

对应代码第 393 行 `_jacobianOplusXj`。

---

## 5. 退化处理

| 退化条件 | 检测方式 | 处理 |
|----------|---------|------|
| 方向为零 | d.squaredNorm() < 1e-10 | 误差和雅可比置零 |
| 力矩爆炸 | w.squaredNorm() > 1e10 | 误差和雅可比置零 |
| 深度不足 | p0.z < 0.1 或 p1.z < 0.1 | 误差和雅可比置零 |
| 投影点重合 | s = \|\|(n1,n2)\|\| < 1e-6 | 误差和雅可比置零 |
| 数值异常 | 逐列检查 NaN/Inf | 对应列置零 |

---

## 6. 总结

### 6.1 维度一览

| 雅可比 | 维度 | 链式分解 |
|--------|------|---------|
| J\_pose | 2×6 | de\_dl(2×3) · dl\_draw(3×3) · dlraw\_dpt(3×4) · dpt\_dp(4×6) · dp\_dLC(6×6) · dLC\_dpose(6×6) |
| J\_line | 2×4 | de\_dl(2×3) · dl\_draw(3×3) · dlraw\_dpt(3×4) · dpt\_dp(4×6) · dp\_dLC(6×6) · dLC\_dLW(6×6) · dLW\_dxi(6×4) |

### 6.2 代码对应表

| 推导层 | 代码变量 | 代码行号 | 维度 |
|--------|---------|---------|------|
| ∂res/∂l\_pred | `de_dl` | 291–297 | 2×3 |
| ∂l\_pred/∂l\_raw | `dl_draw` | 302–311 | 3×3 |
| ∂l\_raw/∂pt | `dlraw_dpt` | 318–321 | 3×4 |
| ∂pt/∂p | `dpt_dp` | 327–336 | 4×6 |
| ∂p/∂L\_C | `dp_dLC` | 345–353 | 6×6 |
| 共享部分 ∂res/∂L\_C | `de_dLC` | 356 | 2×6 |
| ∂L\_C/∂ξ\_pose | `dLC_dpose` | 361–365 | 6×6 |
| ∂L\_C/∂L\_W | `dLC_dLW` | 372–377 | 6×6 |
| ∂L\_W/∂ξ\_line | `dLW_dxi` | 384–391 | 6×4 |
| 位姿雅可比 | `_jacobianOplusXi` | 367 | 2×6 |
| 直线雅可比 | `_jacobianOplusXj` | 393 | 2×4 |
